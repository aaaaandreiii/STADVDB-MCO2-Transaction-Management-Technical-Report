{{> header}}

<section class="card">
  <h2>Replication Dashboard</h2>
  <p>
    This page lets you trigger application-level replication batches between nodes to
    demonstrate:
  </p>
  <ul>
    <li>Regular propagation of writes between central and fragment nodes.</li>
    <li>Failures when a target node is offline.</li>
    <li>Recovery when the node comes back online and pending logs are applied.</li>
  </ul>
</section>

<section class="card">
  <h3>Current Node Statuses</h3>
  <p>
    These are the in-memory online/offline flags used for replication and transaction
    control on this app instance.
  </p>
  <table>
    <thead>
      <tr>
        <th>Node</th>
        <th>Role</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="replication-node-status-body">
      {{!-- Assumes each node has: id, role, online --}}
      {{#each nodes}}
        <tr data-node-id="{{id}}">
          <td>Node {{id}}</td>
          <td>{{role}}</td>
          <td class="node-status">
            {{#if online}}ONLINE{{else}}OFFLINE{{/if}}
          </td>
        </tr>
      {{/each}}
    </tbody>
  </table>
  <p>
    To toggle node status, go to
    <a href="/admin/panel">Admin / Failure Panel</a>.
  </p>
  <button type="button" onclick="refreshNodeStatuses()">Refresh Statuses</button>
</section>

<section class="card">
  <h3>Run a Replication Batch</h3>

  <div class="field-group">
    <label for="sourceNodeId">Source node:</label>
    <select id="sourceNodeId">
      {{#each nodes}}
        <option value="{{id}}">
          Node {{id}} ({{role}})
        </option>
      {{/each}}
    </select>
  </div>

  <div class="field-group">
    <label for="targetNodeId">Target node:</label>
    <select id="targetNodeId">
      {{#each nodes}}
        <option value="{{id}}">
          Node {{id}} ({{role}})
        </option>
      {{/each}}
    </select>
  </div>

  <div class="field-group">
    <label for="batchLimit">Batch size (max events):</label>
    <input id="batchLimit" type="number" min="1" value="10" />
  </div>

  <div class="buttons">
    <button type="button" onclick="runReplication()">
      Run Replication Batch
    </button>
  </div>

  <h4>Replication Results</h4>
  <pre id="replication-log" class="log"></pre>
</section>

<script>
  function logReplication(message, payload) {
    const logEl = document.getElementById('replication-log');
    const ts = new Date().toISOString();
    let line = '[' + ts + '] ' + message;
    if (payload !== undefined) {
      line += '\n  ' + JSON.stringify(payload, null, 2);
    }
    logEl.textContent += line + '\n';
    logEl.scrollTop = logEl.scrollHeight;
  }

  async function fetchJson(url, options) {
    const res = await fetch(url, options || {});
    const data = await res.json();
    if (!data.ok) {
      throw new Error(data.error || 'Unknown error');
    }
    return data;
  }

  async function refreshNodeStatuses() {
    try {
      const data = await fetchJson('/admin/node-status');
      const status = data.status || {};
      const tbody = document.getElementById('replication-node-status-body');
      Array.from(tbody.querySelectorAll('tr')).forEach((row) => {
        const nodeId = parseInt(row.getAttribute('data-node-id'), 10);
        const s = status[nodeId] || { online: true };
        const cell = row.querySelector('.node-status');
        cell.textContent = s.online ? 'ONLINE' : 'OFFLINE';
      });
      logReplication('Refreshed node statuses', status);
    } catch (err) {
      alert('Failed to refresh node statuses: ' + err.message);
    }
  }

  async function runReplication() {
    try {
      const sourceNodeId = parseInt(
        document.getElementById('sourceNodeId').value,
        10
      );
      const targetNodeId = parseInt(
        document.getElementById('targetNodeId').value,
        10
      );
      const limit = parseInt(
        document.getElementById('batchLimit').value,
        10
      ) || 10;

      const data = await fetchJson('/api/replication/run-once', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ sourceNodeId, targetNodeId, limit })
      });

      logReplication('Replication batch outcome', data.outcome);
    } catch (err) {
      logReplication('ERROR running replication batch', { error: err.message });
      alert('Replication failed: ' + err.message);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    refreshNodeStatuses().catch((err) => console.error(err));
  });
</script>

{{> footer}}
